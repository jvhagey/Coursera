### Loading packages

module load samtools/1.2 
module load bowtie2/2.2.4
module load tophat/2.0.9
module load cufflinks/2.1.1

Create a bowtie index of the genome using bowtie2-build, with the prefix ‘athal’. Include a copy of the reference genome with the name “athal.fa” in the index directory.   

#### Apply to question 1-10. 

Align both RNA-seq data sets to the reference genome using tophat. Analyze the results to answer the following questions.   
If multiple answers are required for one question, separate the answers with a space (e.g., 1000 2000).

```
bowtie2-build athal_chr.fa athal

DATADIR=/scicomp/home/qpk9/Coursera/Week4/gencommand_proj4
WORKDIR=/scicomp/home/qpk9/Coursera/Week4/Tophat
ANNOT=/scicomp/home/qpk9/Coursera/Week4/gencommand_proj4/athal_genes.gtf
BWT2IDX=/scicomp/home/qpk9/Coursera/Week4/gencommand_proj4/Bowtie_Index/athal

mkdir -p $WORKDIR/Day8
mkdir -p $WORKDIR/Day16

tophat -o $WORKDIR/Day8 -p 10 -G ANNOT $BWT2IDX $DATADIR/Day8.fastq

tophat -o $WORKDIR/Day16 -p 10 -G ANNOT $BWT2IDX $DATADIR/Day16.fastq
```

1.  How many alignments were produced for the ‘Day8’ RNA-seq data set?  
`samtools view Tophat/Day8/accepted_hits.bam | cut -f7 | wc -l`  
2.  How many alignments were produced for the ‘Day16’ RNA-seq data set?  
`samtools view Tophat/Day16/accepted_hits.bam | cut -f7 | wc -l`  
3.  How many reads were mapped in ‘Day8’ RNA-seq data set?  
`head Tophat/Day8/align_summary.txt`  
4.  How many reads were mapped in ‘Day16’ RNA-seq data set?  
`head Tophat/Day16/align_summary.txt`  
5.  How many reads were uniquely aligned in ‘Day8’ RNA-seq data set?  
6.  How many reads were uniquely aligned in ‘Day16’ RNA-seq data set?  
7.  How many spliced alignments were reported for ‘Day8’ RNA-seq data set? 
`samtools view Tophat/Day8/accepted_hits.bam | cut -f6 | grep "N" | wc -l`  
8.  How many spliced alignments were reported for ‘Day16’ RNA-seq data set?
`samtools view Tophat/Day16/accepted_hits.bam | cut -f6 | grep "N" | wc -l`  
9.  How many reads were left unmapped from ‘Day8’ RNA-seq data set?  
10.  How many reads were left unmapped from ‘Day16’ RNA-seq data set?  

#### Apply to question 11-20. 

Assemble the aligned RNA-seq reads into genes and transcripts using cufflinks. Use the labels ‘Day8’ and ‘Day16’, respectively, when creating identifiers.  
For this portion of the analysis, answer the following questions.  
```
mkdir -p Cufflinks
mkdir -p Cufflinks/Day8
mkdir -p Cufflinks/Day16
```

11.  How many genes were generated by cufflinks for Day8?  
```
cufflinks -L Day8 Tophat/Day8/accepted_hits.bam -o Cufflinks/Day8
cat Cufflinks/Day8/transcripts.gtf | cut -f9 | cut -d ";" -f1 | sort -u | wc -l
```
12.  How many genes were generated by cufflinks for Day16? 
```
cufflinks -L Day16 Tophat/Day16/accepted_hits.bam -o Cufflinks/Day16
cat Cufflinks/Day16/transcripts.gtf | cut -f9 | cut -d ";" -f1 | sort -u | wc -l
```
13.  How many transcripts were reported for Day8?  
`cat Cufflinks/Day8/transcripts.gtf | cut -f9 | cut -d ";" -f2 | sort -u | wc -l`  
14.  How many transcripts were reported for Day16?  
`cat Cufflinks/Day16/transcripts.gtf | cut -f9 | cut -d ";" -f2 | sort -u | wc -l`  
15.  How many single transcript genes were produced for Day8?  
`cat Cufflinks/Day8/transcripts.gtf | cut -f9 | cut -d ' ' -f2,4 | sort -u | cut -d ' ' -f1 | sort | uniq -c |  grep -c " 1 "`  
16.  How many single transcript genes were produced for Day16?  
`cat Cufflinks/Day16/transcripts.gtf | cut -f9 | cut -d ' ' -f2,4 | sort -u | cut -d ' ' -f1 | sort | uniq -c |  grep -c " 1 "`  
17.  How many single-exon transcripts were in the Day8 set?  
`cat Cufflinks/Day8/transcripts.gtf | cut -f9 | cut -d ' ' -f4 | sort | uniq -c |  grep -c " 2 "`  
18.  How many single-exon transcripts were in the Day16 set?  
`cat Cufflinks/Day16/transcripts.gtf | cut -f9 | cut -d ' ' -f4 | sort | uniq -c |  grep -c " 2 "`  
19.  How many multi-exon transcripts were in the Day8 set?  
20.  How many multi-exon transcripts were in the Day16 set?  


#### Apply to question 21-30. 

Run cuffcompare on the resulting cufflinks transcripts, using the reference gene annotations provided and selecting the option '-R' to consider only 
the reference transcripts that overlap some input transfrag. For this step, using the *.tmap files answer the following, for both sets.

21.  How many cufflinks transcripts fully reconstruct annotation transcripts in Day8?  
```
cd Cufflinks/Day8
cuffcompare -r ../../athal_genes.gtf -R transcripts.gtf
cat cuffcmp.transcripts.gtf.tmap | cut -f3 | grep "=" | wc -l
```
22.  How many cufflinks transcripts fully reconstruct annotation transcripts in Day16?  
```
cd ../Day16
cuffcompare -r ../../athal_genes.gtf -R transcripts.gtf
cat cuffcmp.transcripts.gtf.tmap | cut -f3 | grep "=" | wc -l
```
23.  How many splice variants does the gene AT4G20240 have in the Day8 sample?  
```
cd ../Day8
cat cuffcmp.transcripts.gtf.tmap | grep "AT4G20240" | wc -l
```
24.  How many splice variants does the gene AT4G20240 have in the Day16 sample?  
```
cd ../Day16
cat cuffcmp.transcripts.gtf.tmap | grep "AT4G20240" | wc -l
```
25.  How many cufflinks transcripts are partial reconstructions of reference transcripts (‘contained’)? (Day8)  
```
cd ../Day8
cat cuffcmp.transcripts.gtf.tmap | cuf -f3 | grep "c" | wc -l
```
26.  How many cufflinks transcripts are partial reconstructions of reference transcripts (‘contained’)? (Day16) 
```
cd ../Day16
cat cuffcmp.transcripts.gtf.tmap | cuf -f3 | grep "c" | wc -l
```
27.  How many cufflinks transcripts are novel splice variants of reference genes? (Day8)  
```
cd ../Day8
cat cuffcmp.transcripts.gtf.tmap | cuf -f3 | grep "j" | wc -l
```
28.  How many cufflinks transcripts are novel splice variants of reference genes? (Day16)  
```
cd ../Day16
cat cuffcmp.transcripts.gtf.tmap | cuf -f3 | grep "j" | wc -l
```
29.  How many cufflinks transcripts were formed in the introns of reference genes? (Day8)  
```
cd ../Day8
cat cuffcmp.transcripts.gtf.tmap | cuf -f3 | grep "i" | wc -l
```
30.  How many cufflinks transcripts were formed in the introns of reference genes? (Day16)  
```
cd ../Day16
cat cuffcmp.transcripts.gtf.tmap | cuf -f3 | grep "i" | wc -l
```

#### Apply to question 31-35. 

Perform the differential gene expression analysis. For this, in a first stage run cuffmerge using the provided annotation to merge and reconcile the 
two sets of cufflinks transcripts. Make a note of the resulting file, ‘merged.gtf’. In a second step, use cufdiff to perform the differential expression analysis.   

NOTE: Note that in general at least three replicates per condition are required to establish statistical significance. 
The single replicate example is provided here only to illustrate the analysis.

31.  How many genes (loci) were reported in the merged.gtf file?  
```
cuffmerge -g athal_genes.gtf commands/GTFs.txt
cat merged_asm/merged.gtf | cut -f9 | cut -d ' ' -f2 | sort -u | wc -l
```
32.  How many transcripts?  
`cat merged_asm/merged.gtf | cut -f9 | cut -d ' ' -f4 | sort -u | wc -l`  
33.  How many genes total were included in the gene expression report from cuffdiff?  
```
mkdir Cuffdiff
cuffdiff merged_asm/merged.gtf Tophat/Day8/accepted_hits.bam Tophat/Day16/accepted_hits.bam -o Cuffdiff
cat Cuffdiff/gene_exp.diff | wc -l
```
34.  How many genes were detected as differentially expressed?  
`cat Cuffdiff/gene_exp.diff | cut -f14 | grep "yes" | wc -l`  
35.  How many transcripts were differentially expressed between the two samples?  
`cat Cuffdiff/isoform_exp.diff | cut -f14 | grep "yes" | wc -l`
